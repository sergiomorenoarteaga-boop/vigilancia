<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìπ C√°mara de Vigilancia</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: #fff;
        }
        .header {
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 { font-size: 1.4rem; }
        .header a {
            color: #888;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .header a:hover { color: #fff; }
        .main {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .status-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .status-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #f59e0b;
            animation: pulse 2s infinite;
        }
        .status-dot.active { background: #22c55e; }
        .status-dot.error { background: #ef4444; animation: none; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .status-text { flex: 1; font-size: 0.95rem; }
        .room-box {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        .room-box.visible { display: block; }
        .room-box label {
            display: block;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 8px;
        }
        .room-code {
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 6px;
            color: #22c55e;
            font-family: 'Courier New', monospace;
            user-select: all;
        }
        .room-box small {
            display: block;
            margin-top: 8px;
            color: #888;
            font-size: 0.8rem;
        }
        .btn-copy {
            margin-top: 12px;
            padding: 8px 20px;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22c55e;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-copy:hover { background: rgba(34, 197, 94, 0.3); }
        .video-container {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 16/9;
            border: 1px solid rgba(255,255,255,0.1);
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .overlay {
            position: absolute;
            top: 15px; left: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.6);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .rec-dot {
            width: 8px; height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        .viewers-count {
            position: absolute;
            top: 15px; right: 15px;
            background: rgba(0,0,0,0.6);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #fff;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.15); }
        .btn.danger { border-color: rgba(239,68,68,0.4); color: #ef4444; }
        .btn.danger:hover { background: rgba(239,68,68,0.15); }
        .log {
            margin-top: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
            color: #888;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .log div { padding: 3px 0; }
        .log .info { color: #60a5fa; }
        .log .success { color: #22c55e; }
        .log .warn { color: #f59e0b; }
        .log .err { color: #ef4444; }
        select {
            padding: 10px 14px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            font-size: 0.9rem;
            margin-bottom: 15px;
            width: 100%;
            max-width: 400px;
        }
        option { background: #1a1a2e; color: #fff; }
        .camera-select { text-align: center; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìπ Modo C√°mara</h1>
        <a href="index.html">‚Üê Volver al inicio</a>
    </div>

    <div class="main">
        <div class="status-bar">
            <div class="status-dot" id="statusDot"></div>
            <span class="status-text" id="statusText">Iniciando c√°mara...</span>
        </div>

        <div class="room-box" id="roomBox">
            <label>C√ìDIGO DE SALA</label>
            <div class="room-code" id="roomCode">------</div>
            <small>Comparte este c√≥digo con quien quieras que vea la c√°mara</small>
            <button class="btn-copy" onclick="copyCode()">üìã Copiar c√≥digo</button>
        </div>

        <div class="camera-select">
            <select id="cameraSelect">
                <option value="">Cargando c√°maras...</option>
            </select>
        </div>

        <div class="video-container">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="overlay">
                <div class="rec-dot"></div>
                <span>EN VIVO</span>
            </div>
            <div class="viewers-count" id="viewersCount">üëÅ 0 visores</div>
        </div>

        <div class="controls">
            <button class="btn" onclick="toggleCamera()">üîÑ Cambiar c√°mara</button>
            <button class="btn danger" onclick="stopCamera()">‚èπ Detener</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        let peer = null;
        let localStream = null;
        let connections = [];
        let currentCameraIndex = 0;
        let cameras = [];

        const log = (msg, type = 'info') => {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        };

        const updateViewers = () => {
            document.getElementById('viewersCount').textContent = `üëÅ ${connections.length} visor(es)`;
        };

        const setStatus = (text, state = 'loading') => {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot';
            if (state === 'active') dot.classList.add('active');
            if (state === 'error') dot.classList.add('error');
        };

        function generateRoomId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let id = '';
            for (let i = 0; i < 6; i++) id += chars[Math.floor(Math.random() * chars.length)];
            return id;
        }

        async function loadCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                cameras = devices.filter(d => d.kind === 'videoinput');
                const select = document.getElementById('cameraSelect');
                select.innerHTML = '';
                cameras.forEach((cam, i) => {
                    const opt = document.createElement('option');
                    opt.value = cam.deviceId;
                    opt.textContent = cam.label || `C√°mara ${i + 1}`;
                    select.appendChild(opt);
                });
                select.onchange = () => startStream(select.value);
            } catch (e) {
                log('Error listando c√°maras: ' + e.message, 'err');
            }
        }

        async function startStream(deviceId) {
            try {
                if (localStream) {
                    localStream.getTracks().forEach(t => t.stop());
                }
                const constraints = {
                    video: deviceId
                        ? { deviceId: { exact: deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }
                        : { width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: true
                };
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('localVideo').srcObject = localStream;
                log('üìπ C√°mara activa', 'success');

                // Actualizar streams en conexiones existentes
                connections.forEach(conn => {
                    const senders = conn.peerConnection?.getSenders();
                    if (senders) {
                        localStream.getTracks().forEach(track => {
                            const sender = senders.find(s => s.track?.kind === track.kind);
                            if (sender) sender.replaceTrack(track);
                        });
                    }
                });
            } catch (e) {
                log('Error accediendo a la c√°mara: ' + e.message, 'err');
                setStatus('Error: no se pudo acceder a la c√°mara', 'error');
            }
        }

        async function init() {
            log('Iniciando sistema...', 'info');
            await startStream();
            await loadCameras();

            const roomId = generateRoomId();

            peer = new Peer('vigilancia-' + roomId, {
                debug: 0
            });

            peer.on('open', (id) => {
                log('‚úÖ Conectado al servidor de se√±alizaci√≥n', 'success');
                log(`üìå Sala: ${roomId}`, 'success');
                setStatus('C√°mara activa ‚Äî esperando visores', 'active');
                document.getElementById('roomCode').textContent = roomId;
                document.getElementById('roomBox').classList.add('visible');
            });

            peer.on('call', (call) => {
                log('üìû Nuevo visor conectado', 'success');
                call.answer(localStream);
                connections.push(call);
                updateViewers();

                call.on('close', () => {
                    connections = connections.filter(c => c !== call);
                    updateViewers();
                    log('üëã Un visor se desconect√≥', 'warn');
                });

                call.on('error', (err) => {
                    connections = connections.filter(c => c !== call);
                    updateViewers();
                    log('Error con visor: ' + err.message, 'err');
                });
            });

            peer.on('error', (err) => {
                log('Error PeerJS: ' + err.type + ' - ' + err.message, 'err');
                if (err.type === 'unavailable-id') {
                    log('El c√≥digo ya est√° en uso. Recargando...', 'warn');
                    setTimeout(() => location.reload(), 2000);
                }
            });

            peer.on('disconnected', () => {
                log('‚ö†Ô∏è Desconectado. Intentando reconectar...', 'warn');
                setStatus('Reconectando...', 'loading');
                peer.reconnect();
            });
        }

        function toggleCamera() {
            if (cameras.length < 2) {
                log('Solo hay una c√°mara disponible', 'warn');
                return;
            }
            currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
            const select = document.getElementById('cameraSelect');
            select.selectedIndex = currentCameraIndex;
            startStream(cameras[currentCameraIndex].deviceId);
        }

        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                document.getElementById('localVideo').srcObject = null;
                log('‚èπ C√°mara detenida', 'warn');
                setStatus('C√°mara detenida', 'error');
            }
            connections.forEach(c => c.close());
            connections = [];
            updateViewers();
            if (peer) peer.destroy();
        }

        function copyCode() {
            const code = document.getElementById('roomCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('.btn-copy');
                btn.textContent = '‚úÖ ¬°Copiado!';
                setTimeout(() => btn.textContent = 'üìã Copiar c√≥digo', 2000);
            });
        }

        init();
    </script>
</body>
</html>
