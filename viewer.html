<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Visor de Vigilancia</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: #fff;
        }
        .header {
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 { font-size: 1.4rem; }
        .header a { color: #888; text-decoration: none; font-size: 0.9rem; }
        .header a:hover { color: #fff; }
        .main {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .connect-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        .connect-box h2 { margin-bottom: 8px; font-size: 1.3rem; }
        .connect-box p { color: #aaa; margin-bottom: 20px; font-size: 0.95rem; }
        .input-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .code-input {
            padding: 14px 20px;
            font-size: 1.5rem;
            letter-spacing: 8px;
            text-align: center;
            width: 240px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            outline: none;
            transition: border-color 0.3s;
        }
        .code-input:focus { border-color: #6366f1; }
        .code-input::placeholder {
            letter-spacing: 2px;
            font-size: 1rem;
            color: #555;
        }
        .btn-connect {
            padding: 14px 30px;
            font-size: 1.1rem;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-connect:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(99,102,241,0.4); }
        .btn-connect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .status-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #888;
        }
        .status-dot.connecting { background: #f59e0b; animation: pulse 1.5s infinite; }
        .status-dot.connected { background: #22c55e; }
        .status-dot.error { background: #ef4444; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .video-container {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 16/9;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }
        .video-container.visible { display: block; }
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        .overlay-live {
            position: absolute;
            top: 15px; left: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.6);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .rec-dot {
            width: 8px; height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #fff;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.15); }
        .btn.danger { border-color: rgba(239,68,68,0.4); color: #ef4444; }
        .btn.danger:hover { background: rgba(239,68,68,0.15); }
        .log {
            margin-top: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            max-height: 120px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
            color: #888;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .log div { padding: 3px 0; }
        .log .info { color: #60a5fa; }
        .log .success { color: #22c55e; }
        .log .warn { color: #f59e0b; }
        .log .err { color: #ef4444; }
        .fullscreen-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0,0,0,0.6);
            border: none;
            color: #fff;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background 0.2s;
        }
        .fullscreen-btn:hover { background: rgba(0,0,0,0.8); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì± Modo Visor</h1>
        <a href="index.html">‚Üê Volver al inicio</a>
    </div>

    <div class="main">
        <div class="connect-box" id="connectBox">
            <h2>Conectar a c√°mara</h2>
            <p>Introduce el c√≥digo de 6 caracteres que aparece en la pantalla de la c√°mara</p>
            <div class="input-group">
                <input type="text" class="code-input" id="roomInput" maxlength="6" 
                       placeholder="C√ìDIGO" autocomplete="off" spellcheck="false">
                <button class="btn-connect" id="connectBtn" onclick="connect()">Conectar</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Introduce un c√≥digo para conectarte</span>
        </div>

        <div class="video-container" id="videoContainer">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="overlay-live">
                <div class="rec-dot"></div>
                <span>EN VIVO</span>
            </div>
            <button class="fullscreen-btn" onclick="goFullscreen()" title="Pantalla completa">‚õ∂</button>
        </div>

        <div class="controls" id="controls" style="display:none;">
            <button class="btn" onclick="goFullscreen()">üñ• Pantalla completa</button>
            <button class="btn" id="muteBtn" onclick="toggleMute()">üîá Sin audio</button>
            <button class="btn danger" onclick="disconnect()">‚èπ Desconectar</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        let peer = null;
        let currentCall = null;
        let isMuted = true;

        const logEl = document.getElementById('log');
        const log = (msg, type = 'info') => {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        const setStatus = (text, state) => {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot';
            if (state) dot.classList.add(state);
        };

        // Enter = conectar
        document.getElementById('roomInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') connect();
        });

        // Auto-may√∫sculas
        document.getElementById('roomInput').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        function connect() {
            const code = document.getElementById('roomInput').value.trim().toUpperCase();
            if (code.length !== 6) {
                log('‚ö†Ô∏è El c√≥digo debe tener 6 caracteres', 'warn');
                return;
            }

            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.textContent = 'Conectando...';
            setStatus('Conectando...', 'connecting');
            log('Conectando a sala: ' + code, 'info');

           peer = new Peer({
    debug: 2,
    config: {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            {
                urls: 'turn:openrelay.metered.ca:80',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            },
            {
                urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            }
        ]
    }
});


            peer.on('open', () => {
                log('‚úÖ Conectado al servidor de se√±alizaci√≥n', 'success');
                log('Buscando c√°mara...', 'info');

                // Crear un stream vac√≠o para iniciar la llamada
                const emptyStream = new MediaStream();
                currentCall = peer.call('vigilancia-' + code, emptyStream);

                if (!currentCall) {
                    log('‚ùå No se pudo conectar a la c√°mara', 'err');
                    setStatus('Error al conectar', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Conectar';
                    return;
                }

                currentCall.on('stream', (remoteStream) => {
                    log('üìπ ¬°V√≠deo recibido!', 'success');
                    setStatus('üü¢ Conectado ‚Äî viendo en directo', 'connected');
                    const video = document.getElementById('remoteVideo');
                    video.srcObject = remoteStream;
                    video.muted = isMuted;
                    document.getElementById('videoContainer').classList.add('visible');
                    document.getElementById('controls').style.display = 'flex';
                });

                currentCall.on('close', () => {
                    log('üì¥ La c√°mara se desconect√≥', 'warn');
                    setStatus('Desconectado', 'error');
                    cleanup();
                });

                currentCall.on('error', (err) => {
                    log('Error: ' + err.message, 'err');
                    setStatus('Error de conexi√≥n', 'error');
                    cleanup();
                });
            });

            peer.on('error', (err) => {
                log('Error: ' + err.type, 'err');
                if (err.type === 'peer-unavailable') {
                    log('‚ùå No se encontr√≥ ninguna c√°mara con ese c√≥digo', 'err');
                    setStatus('C√°mara no encontrada', 'error');
                } else {
                    setStatus('Error de conexi√≥n', 'error');
                }
                btn.disabled = false;
                btn.textContent = 'Conectar';
            });

            peer.on('disconnected', () => {
                log('‚ö†Ô∏è Desconectado. Intentando reconectar...', 'warn');
                peer.reconnect();
            });
        }

        function cleanup() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = false;
            btn.textContent = 'Conectar';
            document.getElementById('controls').style.display = 'none';
        }

        function disconnect() {
            if (currentCall) currentCall.close();
            if (peer) peer.destroy();
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('videoContainer').classList.remove('visible');
            setStatus('Desconectado', '');
            log('Desconectado manualmente', 'warn');
            cleanup();
        }

        function toggleMute() {
            const video = document.getElementById('remoteVideo');
            isMuted = !isMuted;
            video.muted = isMuted;
            document.getElementById('muteBtn').textContent = isMuted ? 'üîá Sin audio' : 'üîä Con audio';
        }

        function goFullscreen() {
            const container = document.getElementById('videoContainer');
            if (container.requestFullscreen) container.requestFullscreen();
            else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
        }
    </script>
</body>
</html>

